<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Transaction Validity Rules - Fuel Specifications</title>
        <!-- Custom HTML head -->
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">
        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="../fuel-specs.html">Fuel Specifications</a></li><li class="chapter-item expanded "><a href="../protocol/index.html"><strong aria-hidden="true">1.</strong> Protocol</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../protocol/tx_format/index.html"><strong aria-hidden="true">1.1.</strong> Transaction Format</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../protocol/tx_format/constants.html"><strong aria-hidden="true">1.1.1.</strong> Constants</a></li><li class="chapter-item expanded "><a href="../protocol/tx_format/transaction.html"><strong aria-hidden="true">1.1.2.</strong> Transaction</a></li><li class="chapter-item expanded "><a href="../protocol/tx_format/input.html"><strong aria-hidden="true">1.1.3.</strong> Input</a></li><li class="chapter-item expanded "><a href="../protocol/tx_format/output.html"><strong aria-hidden="true">1.1.4.</strong> Output</a></li><li class="chapter-item expanded "><a href="../protocol/tx_format/witness.html"><strong aria-hidden="true">1.1.5.</strong> Witness</a></li><li class="chapter-item expanded "><a href="../protocol/tx_format/tx_pointer.html"><strong aria-hidden="true">1.1.6.</strong> TXPointer</a></li></ol></li><li class="chapter-item expanded "><a href="../protocol/id/index.html"><strong aria-hidden="true">1.2.</strong> Computing Identifiers</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../protocol/id/transaction.html"><strong aria-hidden="true">1.2.1.</strong> Transaction ID</a></li><li class="chapter-item expanded "><a href="../protocol/id/contract.html"><strong aria-hidden="true">1.2.2.</strong> Contract ID</a></li><li class="chapter-item expanded "><a href="../protocol/id/utxo.html"><strong aria-hidden="true">1.2.3.</strong> UTXO ID</a></li></ol></li><li class="chapter-item expanded "><a href="../protocol/tx_validity.html" class="active"><strong aria-hidden="true">1.3.</strong> Transaction Validity Rules</a></li><li class="chapter-item expanded "><a href="../protocol/cryptographic_primitives.html"><strong aria-hidden="true">1.4.</strong> Cryptographic Primitives</a></li><li class="chapter-item expanded "><a href="../protocol/abi/index.html"><strong aria-hidden="true">1.5.</strong> Application Binary Interface (ABI)</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../protocol/abi/json_abi_format.html"><strong aria-hidden="true">1.5.1.</strong> JSON ABI Format</a></li><li class="chapter-item expanded "><a href="../protocol/abi/receipts.html"><strong aria-hidden="true">1.5.2.</strong> Receipts</a></li><li class="chapter-item expanded "><a href="../protocol/abi/fn_selector_encoding.html"><strong aria-hidden="true">1.5.3.</strong> Function Selector Encoding</a></li><li class="chapter-item expanded "><a href="../protocol/abi/argument_encoding.html"><strong aria-hidden="true">1.5.4.</strong> Argument Encoding</a></li></ol></li><li class="chapter-item expanded "><a href="../protocol/storage_initialization.html"><strong aria-hidden="true">1.6.</strong> Storage Slot Initialization</a></li><li class="chapter-item expanded "><a href="../protocol/block_header.html"><strong aria-hidden="true">1.7.</strong> Block Header Format</a></li></ol></li><li class="chapter-item expanded "><a href="../vm/index.html"><strong aria-hidden="true">2.</strong> FuelVM</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../vm/instruction_set.html"><strong aria-hidden="true">2.1.</strong> Instruction Set</a></li></ol></li><li class="chapter-item expanded "><a href="../network/index.html"><strong aria-hidden="true">3.</strong> Networks</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../network/poa.html"><strong aria-hidden="true">3.1.</strong> Proof of Authority (PoA)</a></li></ol></li><li class="chapter-item expanded "><a href="../tests/index.html"><strong aria-hidden="true">4.</strong> Testing</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../tests/sparse_merkle_tree_tests.html"><strong aria-hidden="true">4.1.</strong> Sparse Merkle Tree</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Fuel Specifications</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/FuelLabs/fuel-specs" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="transaction-validity"><a class="header" href="#transaction-validity">Transaction Validity</a></h1>
<ul>
<li><a href="#transaction-lifecycle">Transaction Lifecycle</a></li>
<li><a href="#access-lists">Access Lists</a></li>
<li><a href="#vm-precondition-validity-rules">VM Precondition Validity Rules</a>
<ul>
<li><a href="#base-sanity-checks">Base Sanity Checks</a></li>
<li><a href="#spending-utxos-and-created-contracts">Spending UTXOs and Created Contracts</a></li>
<li><a href="#sufficient-balance">Sufficient Balance</a></li>
<li><a href="#valid-signatures">Valid Signatures</a></li>
</ul>
</li>
<li><a href="#predicate-verification">Predicate Verification</a></li>
<li><a href="#script-execution">Script Execution</a></li>
<li><a href="#vm-postcondition-validity-rules">VM Postcondition Validity Rules</a>
<ul>
<li><a href="#correct-change">Correct Change</a></li>
<li><a href="#state-changes">State Changes</a></li>
</ul>
</li>
</ul>
<h2 id="transaction-lifecycle"><a class="header" href="#transaction-lifecycle">Transaction Lifecycle</a></h2>
<p>Once a transaction is seen, it goes through several stages of validation, in this order:</p>
<ol>
<li><a href="#vm-precondition-validity-rules">Pre-checks</a></li>
<li><a href="#predicate-verification">Predicate verification</a></li>
<li><a href="#script-execution">Script execution</a></li>
<li><a href="#vm-postcondition-validity-rules">Post-checks</a></li>
</ol>
<h2 id="access-lists"><a class="header" href="#access-lists">Access Lists</a></h2>
<p>The validity rules below assume sequential transaction validation for side effects (i.e. state changes). However, by construction, transactions with disjoint write access lists can be validated in parallel, including with overlapping read-only access lists. Transactions with overlapping write access lists must be validated and placed in blocks in topological order.</p>
<p>UTXOs and contracts in the read-only and write-destroy access lists must exist (i.e. have been created previously) in order for a transaction to be valid. In other words, for a unique state element ID, the write-create must precede the write-destroy.</p>
<p>Read-only access list:</p>
<p>Write-destroy access list:</p>
<ul>
<li>For each <a href="./tx_format/input.html#inputcoin">input <code>InputType.Coin</code></a>
<ul>
<li>The <a href="./id/utxo.html">UTXO ID</a> <code>(txID, outputIndex)</code></li>
</ul>
</li>
<li>For each <a href="./tx_format/input.html#inputcontract">input <code>InputType.Contract</code></a>
<ul>
<li>The <a href="./id/utxo.html">UTXO ID</a> <code>(txID, outputIndex)</code></li>
</ul>
</li>
<li>For each <a href="./tx_format/input.html#inputmessage">input <code>InputType.Message</code></a>
<ul>
<li>The <a href="./id/utxo.html#message-id">message ID</a> <code>messageID</code></li>
</ul>
</li>
</ul>
<p>Write-create access list:</p>
<ul>
<li>For each <a href="./tx_format/output.html#outputcontractcreated">output <code>OutputType.ContractCreated</code></a>
<ul>
<li>The contract ID <code>contractID</code></li>
</ul>
</li>
<li>For each output
<ul>
<li>The <a href="./id/utxo.html">created UTXO ID</a></li>
</ul>
</li>
</ul>
<p>Note that block proposers use the contract ID <code>contractID</code> for inputs and outputs of type <a href="./tx_format/input.html#inputcontract"><code>InputType.Contract</code></a> and <a href="./tx_format/output.html#outputcontract"><code>OutputType.Contract</code></a> rather than the pair of <code>txID</code> and <code>outputIndex</code>.</p>
<p>Note that <a href="./tx_format/output.html#outputmessage"><code>OutputType.Message</code> outputs</a> do not have a <a href="./id/utxo.html">UTXO ID</a>, and are unspendable.</p>
<h2 id="vm-precondition-validity-rules"><a class="header" href="#vm-precondition-validity-rules">VM Precondition Validity Rules</a></h2>
<p>This section defines <em>VM precondition validity rules</em> for transactions: the bare minimum required to accept an unconfirmed transaction into a mempool, and preconditions that the VM assumes to hold prior to execution. Chains of unconfirmed transactions are omitted.</p>
<p>For a transaction <code>tx</code>, UTXO set <code>state</code>, contract set <code>contracts</code>, and message set <code>messages</code>, the following checks must pass.</p>
<h3 id="base-sanity-checks"><a class="header" href="#base-sanity-checks">Base Sanity Checks</a></h3>
<p>Base sanity checks are defined in the <a href="./tx_format/index.html">transaction format</a>.</p>
<h3 id="spending-utxos-and-created-contracts"><a class="header" href="#spending-utxos-and-created-contracts">Spending UTXOs and Created Contracts</a></h3>
<pre><code class="language-py">for input in tx.inputs:
    if input.type == InputType.Contract:
        if not input.contractID in contracts:
                return False
    elif input.type == InputType.Message:
        if not input.messageID in messages:
                return False
    else:
        if not (input.txID, input.outputIndex) in state:
            return False
return True
</code></pre>
<p>If this check passes, the UTXO ID <code>(txID, outputIndex)</code> fields of each contract input is set to the UTXO ID of the respective contract. The <code>txPointer</code> of each input is also set to the TX pointer of the UTXO with ID <code>utxoID</code>.</p>
<h3 id="sufficient-balance"><a class="header" href="#sufficient-balance">Sufficient Balance</a></h3>
<p>For each asset ID <code>asset_id</code> in the input and output set:</p>
<pre><code class="language-py">def sum_inputs(tx, asset_id) -&gt; int:
    total: int = 0
    for input in tx.inputs:
        if (input.type == InputType.Coin and input.asset_id == asset_id) or (input.type == InputType.Message and asset_id == 0):
            total += input.amount
    return total

def sum_outputs(tx, asset_id) -&gt; int:
    total: int = 0
    for output in tx.outputs:
        if (output.type == OutputType.Coin and output.asset_id == asset_id) or (output.type == OutputType.Message and asset_id == 0):
            total += output.amount
    return total

def available_balance(tx, asset_id) -&gt; int:
    availableBalance = sum_inputs(tx, asset_id)
    return availableBalance

def unavailable_balance(tx, asset_id) -&gt; int:
    &quot;&quot;&quot;
    Note: we don't charge for predicate verification because predicates are
    monotonic and the cost of bytes should approximately makes up for this.
    &quot;&quot;&quot;
    sentBalance = sum_outputs(tx, col)
    gasBalance = gasPrice * gasLimit / GAS_PRICE_FACTOR
    # Size excludes witness data as it is malleable (even by third parties!)
    bytesBalance = size(tx) * GAS_PER_BYTE * gasPrice / GAS_PRICE_FACTOR
    # Total fee balance
    feeBalance = ceiling(gasBalance + bytesBalance)
    # Only base asset can be used to pay for gas
    if asset_id != 0:
        return sentBalance
    return sentBalance + feeBalance

return available_balance(tx, asset_id) &gt;= unavailable_balance(tx, asset_id)
</code></pre>
<h3 id="valid-signatures"><a class="header" href="#valid-signatures">Valid Signatures</a></h3>
<pre><code class="language-py">def address_from(pubkey: bytes) -&gt; bytes:
    return sha256(pubkey)[0:32]

for input in tx.inputs:
    if (input.type == InputType.Coin || input.type == InputType.Message) and input.predicateLength == 0:
        # ECDSA signatures must be 64 bytes
        if tx.witnesses[input.witnessIndex].dataLength != 64:
            return False
        # Signature must be from owner
        if address_from(ecrecover(txhash(), tx.witnesses[input.witnessIndex].data)) != input.owner:
            return False
return True
</code></pre>
<p>Signatures and signature verification are specified <a href="./cryptographic_primitives.html#public-key-cryptography">here</a>.</p>
<p>The transaction hash is computed as defined <a href="./id/transaction.html">here</a>.</p>
<h2 id="predicate-verification"><a class="header" href="#predicate-verification">Predicate Verification</a></h2>
<p>For each input of type <code>InputType.Coin</code> or <code>InputType.Message</code>, and <code>predicateLength &gt; 0</code>, <a href="../vm/index.html#predicate-verification">verify its predicate</a>.</p>
<h2 id="script-execution"><a class="header" href="#script-execution">Script Execution</a></h2>
<p>Given transaction <code>tx</code>, the following checks must pass:</p>
<p>If <code>tx.scriptLength == 0</code>, there is no script and the transaction defines a simple balance transfer, so no further checks are required.</p>
<p>If <code>tx.scriptLength &gt; 0</code>, the script must be executed. For each asset ID <code>asset_id</code> in the input set, the free balance available to be moved around by the script and called contracts is <code>freeBalance[asset_id]</code>:</p>
<pre><code class="language-py">freeBalance[asset_id] = available_balance(tx, asset_id) - unavailable_balance(tx, asset_id)
</code></pre>
<p>Once the free balances are computed, the <a href="../vm/index.html#script-execution">script is executed</a>. After execution, the following is extracted:</p>
<ol>
<li>The transaction in-memory on VM termination is used as the final transaction which is included in the block.</li>
<li>The unspent free balance <code>unspentBalance</code> for each asset ID.</li>
<li>The unspent gas <code>unspentGas</code> from the <code>$ggas</code> register.</li>
</ol>
<p>The fees incurred for a transaction are <code>ceiling(((size(tx) * GAS_PER_BYTE) + (tx.gasLimit - unspentGas)) * tx.gasPrice / GAS_PRICE_FACTOR)</code>.</p>
<p>If the transaction as included in a block does not match this final transaction, the block is invalid.</p>
<h2 id="vm-postcondition-validity-rules"><a class="header" href="#vm-postcondition-validity-rules">VM Postcondition Validity Rules</a></h2>
<p>This section defines <em>VM postcondition validity rules</em> for transactions: the requirements for a transaction to be valid after it has been executed.</p>
<p>Given transaction <code>tx</code>, state <code>state</code>, and contract set <code>contracts</code>, the following checks must pass.</p>
<h3 id="correct-change"><a class="header" href="#correct-change">Correct Change</a></h3>
<p>If change outputs are present, they must have:</p>
<ol>
<li>if the transaction does not revert; an <code>amount</code> of <code>unspentBalance + floor((unspentGas * tx.gasPrice) / GAS_PRICE_FACTOR)</code> if their asset ID is <code>0</code>, or an <code>amount</code> of the unspent free balance for that asset ID after VM execution is complete, or</li>
<li>if the transaction reverts; an <code>amount</code> of the initial free balance plus <code>unspentGas * tx.gasPrice</code> if their asset ID is <code>0</code>, or an <code>amount</code> of the initial free balance for that asset ID.</li>
</ol>
<h3 id="state-changes"><a class="header" href="#state-changes">State Changes</a></h3>
<p>Transaction processing is completed by removing spent UTXOs from the state and adding created UTXOs to the state.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../protocol/id/utxo.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                            <a rel="next" href="../protocol/cryptographic_primitives.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../protocol/id/utxo.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                    <a rel="next" href="../protocol/cryptographic_primitives.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>

        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>
        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
    </body>
</html>
